
---
title: "Home Field Advantage — English Premier League"
author: "Group 4: Luca Guerra, Ryan Jingwi"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(tidyverse)
library(lubridate)
```
# The Dataset

```{r read-data}
df <- read_csv("C:/Users/Luca/OneDrive/Desktop/DATS/Intro to data sci/results.csv", locale = locale(encoding = "latin1"))
```

We used the "English Premier League (EPL) Results" dataset by the user "Alvin" consisting of 11,113 observations of premier league games reusults and statistics from 1993 to 2022. The observed variables are:

- Season: soccer season of the game (ex. 2020/2021)
- DateTime: date of the game in yyyy-mm-dd
- HomeTeam: full name of the home team (50 total unique teams)
- AwayTeam: full name of the away team (50 total unique teams)
- FTHG: number of goals scored by the Home Team at the end of the match
- FTAG: number of goals scored by the Away Team at the end of the match
- FTR: Full time result, "A" for games won by the away team, "D" for games ended in a draw, "H" for games won by the Home Team
- HTHG: number of goals scored by the Home Team at halftime
- HTAG: number of goals scored by the Away Team at halftime
- HTR: result at halftime, same method as FTR
- Referee: name of the referee if known
- HS: number of shots by the home team
- AS: number of shots by the away team
- HST: number of shots on target by the home team (<=HS)
- AST: number of shots on target by the away team (<=AS)
- HC: number of corners for the home team
- AC: number of corners by the away team
- HF: number of fouls committed by the home team
- AF: number of fouls committed by the away team
- HY: number of yellow cards shown to the home team
- AY: number of yellow cards shown to the away team
- HR: number of red cards shown to the home team
- AR: number of red cards shown to the away team

To find out a potential home advantage, we will consider only the final scores and ignore the halftime, fouls, shots, cards and referee data for this purpose. Other effects can be explored in a second analysis using the statistics, to find out if referees can be biased by a field effect too. 


```{r}
str(df)

```



# Slide 5: Initial EDA – Match Outcomes

## Home vs Away: Outcome Breakdown


```{r outcomes}
# Create outcome counts
outcomes <- df %>%
  mutate(Result = case_when(
    FTR == "H" ~ "HomeWin",
    FTR == "A" ~ "AwayWin",
    FTR == "D" ~ "Draw",
    TRUE ~ "Other"
  )) %>%
  count(Result) %>%
  mutate(pct = n / sum(n) * 100)

outcomes
```

- `% of home wins, away wins, draws`
- `Clear skew towards home wins?`

```{r outcomes-plot, fig.height=4, fig.width=6}
# Bar chart of outcomes
ggplot(outcomes, aes(x = Result, y = pct, fill = Result)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = paste0(round(pct,1), "%")), vjust = -0.5) +
  labs(title = "Home vs Away: Outcome Breakdown",
       x = "", y = "% of matches") +
  theme_minimal()
```

*Suggested speaking line:* “As we can see, home teams win more often — but let’s dig deeper.”

# Slide 6: Goals Scored: Home vs Away

## Do Home Teams Score More Goals?

```{r goals-stats}
# Basic goal stats
goal_stats <- df %>%
  summarize(
    avg_home_goals = mean(FTHG, na.rm = TRUE),
    avg_away_goals = mean(FTAG, na.rm = TRUE)
  )

goal_stats
```

```{r goal-diff}
# Goal difference distribution (home - away)
df2 <- df %>%
  mutate(goal_diff = FTHG - FTAG)

# Histogram of goal differences
ggplot(df2, aes(x = goal_diff)) +
  geom_histogram(binwidth = 1, boundary = -0.5) +
  labs(title = "Histogram of Goal Differences (Home - Away)",
       x = "Goal difference (Home - Away)", y = "Count") +
  theme_minimal()
```

```{r goals-boxplot, fig.height=4, fig.width=6}
# Boxplot comparing home and away goals per match
df_long <- df %>%
  select(FTHG, FTAG) %>%
  pivot_longer(cols = everything(), names_to = "side", values_to = "goals") %>%
  mutate(side = if_else(side == "FTHG", "Home", "Away"))

ggplot(df_long, aes(x = side, y = goals)) +
  geom_boxplot() +
  labs(title = "Home vs Away Goals per Match",
       x = "", y = "Goals") +
  theme_minimal()
```

# Slide 7: Points Per Game (PPG)

## Points Earned: Home vs Away

```{r points-calc}
# Assign points per match
df_points <- df %>%
  mutate(
    home_points = case_when(
      FTR == "H" ~ 3,
      FTR == "D" ~ 1,
      FTR == "A" ~ 0,
      TRUE ~ NA_real_
    ),
    away_points = case_when(
      FTR == "A" ~ 3,
      FTR == "D" ~ 1,
      FTR == "H" ~ 0,
      TRUE ~ NA_real_
    )
  )

ppg_summary <- df_points %>%
  summarize(
    avg_home_ppg = mean(home_points, na.rm = TRUE),
    avg_away_ppg = mean(away_points, na.rm = TRUE)
  )

ppg_summary
```

```{r ppg-plot, fig.height=4, fig.width=6}
ppg_plot <- ppg_summary %>%
  pivot_longer(everything(), names_to = "side", values_to = "ppg") %>%
  mutate(side = recode(side, "avg_home_ppg" = "Home", "avg_away_ppg" = "Away"))

ggplot(ppg_plot, aes(x = side, y = ppg, fill = side)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = round(ppg,2)), vjust = -0.5) +
  labs(title = "Average Points per Match: Home vs Away", x = "", y = "Avg PPG") +
  theme_minimal()
```

# Slide 8: Trends Over Time

## Has Home Advantage Changed Over Time?

```{r season-trends}
# Ensure Season is treated consistently (some files use 'Season' as string)
# We'll group by Season (if not present, fall back to year from DateTime)
if("Season" %in% colnames(df)) {
  df_season <- df %>% mutate(Season = as.character(Season))
} else {
  df_season <- df %>% mutate(Season = year(ymd_hms(DateTime)))
}

season_summary <- df_points %>%
  mutate(Season = as.character(Season)) %>%
  group_by(Season) %>%
  summarize(
    matches = n(),
    pct_home_wins = mean(FTR == "H") * 100,
    avg_home_ppg = mean(home_points, na.rm = TRUE),
    avg_away_ppg = mean(away_points, na.rm = TRUE),
    ppg_diff = avg_home_ppg - avg_away_ppg
  ) %>%
  arrange(Season)

season_summary
```

```{r season-plot1, fig.height=4, fig.width=8}
# Line graph: % home wins per season
ggplot(season_summary, aes(x = as.integer(substr(Season,1,4)), y = pct_home_wins)) +
  geom_line() + geom_point() +
  labs(title = "% Home Wins per Season", x = "Season (first year)", y = "% Home Wins") +
  theme_minimal()
```

```{r season-plot2, fig.height=4, fig.width=8}
# Line graph: PPG difference over time
ggplot(season_summary, aes(x = as.integer(substr(Season,1,4)), y = ppg_diff)) +
  geom_line() + geom_point() +
  labs(title = "Difference in Home vs Away PPG per Season (Home - Away)",
       x = "Season (first year)", y = "PPG Difference") +
  theme_minimal()
```

“We noticed that home advantage may be shrinking in recent years, especially during COVID-19 seasons.”

# T test

```{r t_test_home_advantage, message=FALSE, warning=FALSE}
# Paired t-test for home vs away win rates
library(dplyr)

# Create binary win indicators
df <- df %>%
  mutate(
    home_win = ifelse(FTR == "H", 1, 0),
    away_win = ifelse(FTR == "A", 1, 0)
  )

# Calculate win rates for each team
home_rates <- df %>%
  group_by(team = HomeTeam) %>%
  summarise(home_winrate = mean(home_win, na.rm = TRUE))

away_rates <- df %>%
  group_by(team = AwayTeam) %>%
  summarise(away_winrate = mean(away_win, na.rm = TRUE))

# Merge and run paired t-test
team_rates <- inner_join(home_rates, away_rates, by = "team")

t_test <- t.test(team_rates$home_winrate,
                 team_rates$away_winrate,
                 paired = TRUE,
                 alternative = "greater")

t_test

boxplot(team_rates$home_winrate, team_rates$away_winrate,
        names = c("Home", "Away"),
        ylab = "Win Rate",
        main = "Premier League: Home vs Away Win Rates")

library(dplyr)

# Create binary win indicators
df <- df %>%
  mutate(
    home_win = ifelse(FTR == "H", 1, 0),
    away_win = ifelse(FTR == "A", 1, 0)
  )

# Compute home/away win rates per team
home_rates <- df %>%
  group_by(team = HomeTeam) %>%
  summarise(home_winrate = mean(home_win, na.rm = TRUE))

away_rates <- df %>%
  group_by(team = AwayTeam) %>%
  summarise(away_winrate = mean(away_win, na.rm = TRUE))

# Merge for paired comparison
team_rates <- inner_join(home_rates, away_rates, by = "team")

# Compute win rate differences
team_rates <- team_rates %>%
  mutate(diff = home_winrate - away_winrate)

# Identify and remove outliers (1.5 * IQR rule)
iqr_val <- IQR(team_rates$diff, na.rm = TRUE)
lower_bound <- quantile(team_rates$diff, 0.25, na.rm = TRUE) - 1.5 * iqr_val
upper_bound <- quantile(team_rates$diff, 0.75, na.rm = TRUE) + 1.5 * iqr_val

team_rates_clean <- team_rates %>%
  filter(diff >= lower_bound, diff <= upper_bound)

cat("Removed", nrow(team_rates) - nrow(team_rates_clean), "outlier team(s)\n")

# Run paired t-test on cleaned data
t_test_clean <- t.test(team_rates_clean$home_winrate,
                       team_rates_clean$away_winrate,
                       paired = TRUE,
                       alternative = "greater")

t_test_clean

boxplot(team_rates_clean$home_winrate, team_rates_clean$away_winrate,
        names = c("Home", "Away"),
        ylab = "Clean Win Rate",
        main = "Premier League: Home vs Away Win Rates")



```


# Slide 9: Possible Explanations

## Why Might Home Teams Perform Better?

- Crowd support and familiarity with pitch
- Referee bias (unconscious)
- Travel fatigue for away teams
- Tactical adjustments at home

# Slide 10: Conclusion

## Is There a Real Home Advantage?

- Data shows consistent advantage for home teams
- Higher win rate, more goals, more points
- Advantage is shrinking slightly over time
- **Answer:** Yes, but the impact is contextual

# Slide 11: Limitations & Future Work

## What Could Be Improved or Expanded?

- Include team strength or ranking to adjust for quality
- Consider special cases (derbies, weather, stadium size)
- Look at other leagues for comparison
- Use modeling for predictive analysis

---

## Appendix: Data checks

```{r checks}
# Missing values overview
map_df(df, ~sum(is.na(.))) %>% pivot_longer(everything(), names_to="col", values_to="missing")
```
